[
    {
        "title": "{{ qpu_name }}",
        "rows": [
            {% set ns = namespace(y_position=0) %}
            {% set panels_per_row = panels_per_row or 4 %}
            {% set panel_height_small = panel_height_small or 2 %}
            {% for panel in metric_panels %}
            {
                "title": "{{ panel.title }}",
                "grid_pos": { "x": 0, "y": {{ ns.y_position }} },
                "panels": [
                    {% for qubit_id in range(qubits) %}
                    {
                        "type": "Stat",
                        "value": {
                            "title": "Qubit {{ qubit_id }}",
                            "grid_pos": {
                                "x": {{ (qubit_id % panels_per_row) * panel.width }},
                                "y": {{ ns.y_position + 1 + (qubit_id // panels_per_row) * (panel_height_small + panel.height) }},
                                "w": {{ panel.width }},
                                "h": {{ panel_height_small }}
                            },
                            "unit": "{{ panel.unit }}",
                            "targets": [
                                {% for metric in panel.metrics %}
                                {
                                    "type": "Target",
                                    "value": {
                                        "datasource": "postgres",
                                        "rawSql": "SELECT {{ metric.name }}, acquisition_time FROM qubit WHERE qpu_name='{{ qpu_name }}' AND qubit_id={{ qubit_id }}",
                                        "legendFormat": "{{ metric.name }}",
                                        "color": "{{ metric.color }}",
                                        "sql": {
                                            "columns": [
                                                {
                                                    "type": "function",
                                                    "parameters": [
                                                        {
                                                            "type": "functionParameter",
                                                            "name": "{{ metric.name }}"
                                                        }
                                                    ]
                                                },
                                                {
                                                    "type": "function",
                                                    "parameters": [
                                                        {
                                                            "type": "functionParameter",
                                                            "name": "acquisition_time"
                                                        }
                                                    ]
                                                }
                                            ],
                                            "groupBy": [
                                                {
                                                    "type": "groupBy",
                                                    "property": {
                                                        "type": "string"
                                                    }
                                                }
                                            ],
                                            "limit": 50
                                        },
                                        "table": "qubit"
                                    }
                                }{% if not loop.last %},{% endif %}
                                {% endfor %}
                            ]
                        }
                    },
                    {
                        "type": "TimeSeries",
                        "value": {
                            "title": "",
                            "grid_pos": {
                                "x": {{ (qubit_id % panels_per_row) * panel.width }},
                                "y": {{ ns.y_position + 1 + (qubit_id // panels_per_row) * (panel_height_small + panel.height) + panel_height_small }},
                                "w": {{ panel.width }},
                                "h": {{ panel.height }}
                            },
                            "unit": "{{ panel.unit }}",
                            "targets": [
                                {% for metric in panel.metrics %}
                                {
                                    "type": "Target",
                                    "value": {
                                        "datasource": "postgres",
                                        "rawSql": "SELECT {{ metric.name }}, acquisition_time FROM qubit WHERE qpu_name='{{ qpu_name }}' AND qubit_id={{ qubit_id }}",
                                        "legendFormat": "{{ metric.name }}",
                                        "color": "{{ metric.color }}",
                                        "sql": {
                                            "columns": [
                                                {
                                                    "type": "function",
                                                    "parameters": [
                                                        {
                                                            "type": "functionParameter",
                                                            "name": "{{ metric.name }}"
                                                        }
                                                    ]
                                                },
                                                {
                                                    "type": "function",
                                                    "parameters": [
                                                        {
                                                            "type": "functionParameter",
                                                            "name": "acquisition_time"
                                                        }
                                                    ]
                                                }
                                            ],
                                            "groupBy": [
                                                {
                                                    "type": "groupBy",
                                                    "property": {
                                                        "type": "string"
                                                    }
                                                }
                                            ],
                                            "limit": 50
                                        },
                                        "table": "qubit"
                                    }
                                }{% if not loop.last %},{% endif %}
                                {% endfor %}
                            ]
                        }
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            }
            {% set ns.y_position = ns.y_position +  1 + (qubits // panels_per_row) * (panel_height_small + panel.height) + (panel_height_small + panel.height) %}
            {% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    }
]
